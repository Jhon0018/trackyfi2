<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estado Financiero - TrackYfi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap y FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts y animaciones -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: radial-gradient(ellipse at 60% 40%, #38bdf8 0%, #0ea5e9 40%, #1e293b 100%);
            color: #f1f5f9;
            font-family: 'Roboto', Arial, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            background: rgba(30, 41, 59, 0.98);
            border-radius: 32px;
            box-shadow: 0 12px 48px 0 rgba(14,165,233,0.25), 0 1.5px 12px 0 #38bdf8;
            padding: 3rem 2.5rem 2.5rem 2.5rem;
            margin-top: 2.5rem;
            margin-bottom: 2.5rem;
            border: 2.5px solid #38bdf8;
            position: relative;
            z-index: 2;
        }
        .neon-glow {
            text-shadow: 0 0 8px #38bdf8, 0 0 16px #0ea5e9, 0 0 32px #38bdf8;
        }
        h2, h4 {
            font-family: 'Orbitron', Arial, sans-serif;
            letter-spacing: 2px;
            color: #38bdf8;
            text-shadow: 0 2px 16px #0ea5e9, 0 0 8px #38bdf8;
        }
        .form-control, .btn-primary {
            border-radius: 16px;
            font-size: 1.15rem;
        }
        .btn-primary {
            background: linear-gradient(90deg, #38bdf8 0%, #0ea5e9 100%);
            border: none;
            font-weight: bold;
            box-shadow: 0 2px 16px #0ea5e9, 0 0 8px #38bdf8;
            transition: transform 0.15s, box-shadow 0.15s;
            letter-spacing: 1px;
        }
        .btn-primary:hover {
            transform: scale(1.08) rotate(-2deg);
            background: linear-gradient(90deg, #0ea5e9 0%, #38bdf8 100%);
            box-shadow: 0 4px 32px #38bdf8, 0 0 16px #0ea5e9;
        }
        .ratio-card {
            min-height: 270px;
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            color: #fff;
            border-radius: 22px;
            box-shadow: 0 6px 32px 0 rgba(14,165,233,0.25), 0 0 12px #38bdf8;
            border: 2px solid #38bdf8;
            transition: box-shadow 0.25s, transform 0.25s;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .ratio-card:before {
            content: "";
            position: absolute;
            top: -60px; left: -60px;
            width: 120px; height: 120px;
            background: radial-gradient(circle, #fff3 0%, transparent 80%);
            filter: blur(8px);
            z-index: 0;
        }
        .ratio-card:hover {
            box-shadow: 0 12px 48px 0 #38bdf8, 0 0 32px #0ea5e9;
            transform: translateY(-8px) scale(1.04) rotate(1deg);
        }
        .ratio-card .card-title {
            font-size: 1.35rem;
            font-family: 'Orbitron', Arial, sans-serif;
            color: #fff;
            letter-spacing: 1.5px;
            text-shadow: 0 0 8px #0ea5e9;
        }
        .ratio-card ul li {
            font-size: 1.13rem;
            margin-bottom: 0.5rem;
            font-family: 'Roboto', Arial, sans-serif;
            letter-spacing: 0.5px;
            text-shadow: 0 0 4px #0ea5e9;
        }
        .table-financial {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 24px 0 #0ea5e9, 0 0 8px #38bdf8;
            margin-bottom: 2.5rem;
            border: 2px solid #38bdf8;
        }
        .table-financial th {
            background: linear-gradient(90deg, #38bdf8 0%, #0ea5e9 100%);
            color: #fff;
            font-size: 1.13rem;
            border: none;
            text-align: center;
            letter-spacing: 1px;
            text-shadow: 0 0 6px #0ea5e9;
        }
        .table-financial td {
            background: rgba(30, 41, 59, 0.92);
            color: #f1f5f9;
            border: none;
            text-align: center;
            font-size: 1.09rem;
            transition: background 0.2s, color 0.2s;
        }
        .table-financial tr:hover td {
            background: #0ea5e9;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 8px #38bdf8;
        }
        .spinner-border {
            color: #38bdf8 !important;
        }
        .alert-danger, .alert-warning, .alert-info {
            border-radius: 14px;
            font-size: 1.13rem;
            box-shadow: 0 0 12px #0ea5e9;
            background: rgba(30, 41, 59, 0.98);
            color: #fff;
            border: 2px solid #38bdf8;
        }
        /* Animación de entrada */
        .fade-in {
            animation: fadeInUp 0.9s cubic-bezier(.39,.575,.565,1.000) both;
        }
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(60px) scale(0.98);}
            100% { opacity: 1; transform: translateY(0) scale(1);}
        }
        /* Animación de fondo flotante */
        .bg-float {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .bg-float span {
            position: absolute;
            display: block;
            border-radius: 50%;
            opacity: 0.18;
            filter: blur(16px);
            animation: float 12s infinite linear;
        }
        .bg-float .b1 { width: 220px; height: 220px; background: #38bdf8; left: 10vw; top: 10vh; animation-delay: 0s;}
        .bg-float .b2 { width: 180px; height: 180px; background: #0ea5e9; left: 70vw; top: 20vh; animation-delay: 2s;}
        .bg-float .b3 { width: 140px; height: 140px; background: #38bdf8; left: 50vw; top: 70vh; animation-delay: 4s;}
        @keyframes float {
            0% { transform: translateY(0) scale(1);}
            50% { transform: translateY(-40px) scale(1.08);}
            100% { transform: translateY(0) scale(1);}
        }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 10px;
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
            border-radius: 8px;
        }
        /* Responsive */
        @media (max-width: 900px) {
            .container { padding: 1.2rem 0.5rem; }
            .ratio-card { min-height: 200px; }
            .table-financial th, .table-financial td { font-size: 0.97rem; }
        }
        @media (max-width: 600px) {
            .container { padding: 0.5rem 0.1rem; }
            h2 { font-size: 1.3rem; }
            h4 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
<div class="bg-float">
    <span class="b1"></span>
    <span class="b2"></span>
    <span class="b3"></span>
</div>
<div class="container fade-in">
    <h2 class="mb-4 text-center neon-glow"><i class="fas fa-balance-scale"></i> Estado Financiero de <span id="symbolTitle">AAPL</span></h2>
    <div class="mb-4 d-flex flex-wrap justify-content-center align-items-center gap-2">
        <input type="text" id="symbolInput" class="form-control shadow" placeholder="Ej: AAPL, MSFT, TSLA" style="max-width:220px;">
        <button class="btn btn-primary shadow" onclick="loadFinancials()"><i class="fas fa-search"></i> Buscar</button>
    </div>
    <div id="ratios" class="row g-4 justify-content-center"></div>
    <hr>
    <h4 class="mt-4 neon-glow"><i class="fas fa-chart-line"></i> Estado de Resultados</h4>
    <div id="incomeTable" class="table-responsive"></div>
    <h4 class="mt-4 neon-glow"><i class="fas fa-building-columns"></i> Balance General</h4>
    <div id="balanceTable" class="table-responsive"></div>
    <h4 class="mt-4 neon-glow"><i class="fas fa-money-bill-wave"></i> Flujo de Caja</h4>
    <div id="cashflowTable" class="table-responsive"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
async function fetchYahooFinancials(symbol) {
    const url = `https://trackerfolio.com:5000/api/estadof/${symbol}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("No se pudo obtener información financiera.");
    return await res.json();
}

function safe(val) {
    return (val !== undefined && val !== null) ? Number(val).toLocaleString() : '<span style="color:#f87171;font-weight:bold;text-shadow:0 0 6px #f87171;">N/D</span>';
}

function ratio(n, d) {
    if (n === null || n === undefined || d === null || d === undefined || d === 0) return '<span style="color:#f87171;font-weight:bold;text-shadow:0 0 6px #f87171;">N/D</span>';
    return `<span style="color:#38bdf8;font-weight:bold;text-shadow:0 0 6px #38bdf8;">${(n / d).toFixed(4)}</span>`;
}

function buildTable(fields, periods) {
    let html = `<table class="table table-sm table-bordered table-financial"><thead><tr><th>Cuenta</th>`;
    periods.forEach(p => html += `<th>${p}</th>`);
    html += `</tr></thead><tbody>`;
    fields.forEach(f => {
        html += `<tr><td>${f.label}</td>`;
        periods.forEach((p, i) => {
            html += `<td>${safe(f.values[i])}</td>`;
        });
        html += `</tr>`;
    });
    html += `</tbody></table>`;
    return html;
}

async function loadFinancials() {
    const symbol = document.getElementById('symbolInput').value.trim() || 'AAPL';
    document.getElementById('symbolTitle').textContent = symbol.toUpperCase();
    document.getElementById('ratios').innerHTML = '<div class="text-center my-4"><div class="spinner-border"></div></div>';
    document.getElementById('incomeTable').innerHTML = '';
    document.getElementById('balanceTable').innerHTML = '';
    document.getElementById('cashflowTable').innerHTML = '';

    try {
        const data = await fetchYahooFinancials(symbol);

        if (!data.incomeStatementHistory || !data.incomeStatementHistory.incomeStatementHistory || data.incomeStatementHistory.incomeStatementHistory.length === 0) {
            document.getElementById('ratios').innerHTML = `<div class="alert alert-danger fade-in">No se encontró información financiera para el símbolo <b>${symbol.toUpperCase()}</b>. Prueba con otro (ej: AAPL, MSFT, TSLA).</div>`;
            return;
        }

        // Extraer periodos (años)
        const periods = (data?.incomeStatementHistory?.incomeStatementHistory || []).map(e =>
            e.endDate ? new Date(e.endDate.raw * 1000).getFullYear() : 'N/D'
        );

        function extract(field, arr) {
            return arr.map(e => e[field]?.raw ?? null);
        }
        const incomeArr = data?.incomeStatementHistory?.incomeStatementHistory || [];
        const balanceArr = data?.balanceSheetHistory?.balanceSheetStatements || [];
        const cashArr = data?.cashflowStatementHistory?.cashflowStatements || [];

        const incomeFields = [
            { label: "Total Revenue", values: extract("totalRevenue", incomeArr) },
            { label: "Cost Of Revenue", values: extract("costOfRevenue", incomeArr) },
            { label: "Gross Profit", values: extract("grossProfit", incomeArr) },
            { label: "Operating Expense", values: extract("totalOperatingExpenses", incomeArr) },
            { label: "Operating Income", values: extract("operatingIncome", incomeArr) },
            { label: "Net Income", values: extract("netIncome", incomeArr) },
            { label: "EBITDA", values: extract("ebitda", incomeArr) },
            { label: "Basic EPS", values: extract("basicEPS", incomeArr) },
            { label: "Diluted EPS", values: extract("dilutedEPS", incomeArr) }
        ];
        const balanceFields = [
            { label: "Total Assets", values: extract("totalAssets", balanceArr) },
            { label: "Total Liab", values: extract("totalLiab", balanceArr) },
            { label: "Total Stockholder Equity", values: extract("totalStockholderEquity", balanceArr) },
            { label: "Long Term Debt", values: extract("longTermDebt", balanceArr) }
        ];
        const cashFields = [
            { label: "Total Cash From Operating Activities", values: extract("totalCashFromOperatingActivities", cashArr) },
            { label: "Total Cashflows From Investing Activities", values: extract("totalCashflowsFromInvestingActivities", cashArr) },
            { label: "Total Cash From Financing Activities", values: extract("totalCashFromFinancingActivities", cashArr) },
            { label: "Change In Cash", values: extract("changeInCash", cashArr) }
        ];

        document.getElementById('incomeTable').innerHTML = buildTable(incomeFields, periods);
        document.getElementById('balanceTable').innerHTML = buildTable(balanceFields, periods);
        document.getElementById('cashflowTable').innerHTML = buildTable(cashFields, periods);

        // Ratios
        let ratiosHTML = '';
        for (let i = 0; i < periods.length; i++) {
            const revenue = incomeFields[0].values[i];
            const net_income = incomeFields[5].values[i];
            const ebitda = incomeFields[6].values[i];
            const gross_profit = incomeFields[2].values[i];
            const total_assets = balanceFields[0].values[i];
            const total_liab = balanceFields[1].values[i];
            const equity = balanceFields[2].values[i];
            const cash_op = cashFields[0].values[i];

            ratiosHTML += `
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card shadow-sm ratio-card fade-in">
                    <div class="card-body">
                        <h6 class="card-title mb-2"><i class="fas fa-calendar-alt"></i> ${periods[i]}</h6>
                        <ul class="list-unstyled mb-0">
                            <li>📈 Margen Neto: ${ratio(net_income, revenue)}</li>
                            <li>📊 ROE: ${ratio(net_income, equity)}</li>
                            <li>💸 Deuda/Activos: ${ratio(total_liab, total_assets)}</li>
                            <li>🏦 Deuda/Patrimonio: ${ratio(total_liab, equity)}</li>
                            <li>🧪 Margen Bruto: ${ratio(gross_profit, revenue)}</li>
                            <li>📉 EBITDA/Ingresos: ${ratio(ebitda, revenue)}</li>
                            <li>💵 CashFlow Op/Ingresos: ${ratio(cash_op, revenue)}</li>
                        </ul>
                    </div>
                </div>
            </div>`;
        }
        document.getElementById('ratios').innerHTML = ratiosHTML || '<div class="alert alert-warning fade-in">No hay ratios disponibles.</div>';
    } catch (e) {
        document.getElementById('ratios').innerHTML = `<div class="alert alert-danger fade-in">No se pudo obtener información financiera para este símbolo.<br>${e.message}</div>`;
        document.getElementById('incomeTable').innerHTML = '';
        document.getElementById('balanceTable').innerHTML = '';
        document.getElementById('cashflowTable').innerHTML = '';
    }
}
window.onload = loadFinancials;
</script>
</body>
</html>